generator client {
  provider        = "prisma-client"
  previewFeatures = ["driverAdapters", "fullTextSearchPostgres", "postgresqlExtensions", "queryCompiler", "relationJoins"]
  output          = "./generated"
  engineType      = "client"

  // moduleFormat           = "esm"
  generatedFileExtension = "ts"
  // generated extensions
  importFileExtension    = "ts"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  // extensions = [pgvector(map: "vector", schema: "public")]
}

model User {
  id               String   @id @default(cuid())
  name             String
  email            String
  emailVerified    Boolean  @default(false) @map("email_verified")
  image            String?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")
  stripeCustomerId String?  @map("stripe_customer_id")

  // Admin plugin fields
  role       String?   @default("user")
  banned     Boolean?  @default(false)
  banReason  String?   @map("ban_reason")
  banExpires DateTime? @map("ban_expires")

  // Email preferences
  emailNotificationsContentPlanner   Boolean @default(true) @map("email_notifications_content_planner")
  emailNotificationsArticleGenerated Boolean @default(true) @map("email_notifications_article_generated")

  sessions    Session[]
  accounts    Account[]
  members     Member[]
  invitations Invitation[]
  jobs        Job[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String   @id @default(cuid())
  expiresAt            DateTime @map("expires_at")
  token                String
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  ipAddress            String?  @map("ip_address")
  userAgent            String?  @map("user_agent")
  userId               String   @map("user_id")
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?  @map("active_organization_id")
  activeProductId      String?  @map("active_product_id")

  // Admin plugin field
  impersonatedBy String? @map("impersonated_by")

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  userId                String    @map("user_id")
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  idToken               String?   @map("id_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("verification")
}

model Organization {
  id       String  @id @default(cuid())
  name     String
  slug     String?
  logo     String?
  metadata String?

  members     Member[]
  invitations Invitation[]
  products    Product[]

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @map("user_id")
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime     @default(now()) @map("created_at")

  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime     @map("expires_at")
  inviterId      String       @map("inviter_id")
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Subscription {
  id                   String    @id @default(cuid())
  plan                 String
  referenceId          String    @map("reference_id")
  stripeCustomerId     String?   @map("stripe_customer_id")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  status               String?
  periodStart          DateTime? @map("period_start")
  periodEnd            DateTime? @map("period_end")
  trialStart           DateTime? @map("trial_start")
  trialEnd             DateTime? @map("trial_end")
  cancelAtPeriodEnd    Boolean?  @default(false) @map("cancel_at_period_end")
  seats                Int?

  product Product?

  @@map("subscription")
}

model Product {
  id              String   @id @default(cuid())
  url             String
  name            String?
  description     String?
  logo            String?
  language        String?
  country         String?
  targetAudiences String[] @map("target_audiences")
  sitemapUrl      String?  @map("sitemap_url")
  blogUrl         String?  @map("blog_url")
  bestArticles    String[] @map("best_articles")
  competitors     String[] @default([])

  // Linking configuration
  linkSource    String @default("sitemap") @map("link_source") // "database" or "sitemap"
  detectedLinks Json?  @map("detected_links") // Cached links from sitemap

  // Article preferences
  autoPublish         Boolean @default(true) @map("auto_publish")
  articleStyle        String  @default("informative") @map("article_style")
  internalLinks       Int     @default(3) @map("internal_links")
  globalInstructions  String? @map("global_instructions")
  imageStyle          String  @default("brand-text") @map("image_style")
  brandColor          String  @default("#000000") @map("brand_color")
  includeYoutubeVideo Boolean @default(true) @map("include_youtube_video")
  includeCallToAction Boolean @default(true) @map("include_call_to_action")
  includeInfographics Boolean @default(true) @map("include_infographics")
  includeEmojis       Boolean @default(true) @map("include_emojis")

  subscriptionId String?       @unique @map("subscription_id")
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  articles    Article[]
  credentials Credential[]
  jobs        Job[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("product")
}

enum ArticleType {
  guide
  listicle
}

enum GuideSubtype {
  how_to
  explainer
  comparison
  reference
}

enum ListicleSubtype {
  round_up
  resources
  examples
}

model Article {
  id        String  @id @default(cuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Article metadata
  slug            String?
  keyword         String
  title           String?
  metaDescription String?          @map("meta_description")
  type            ArticleType?
  guideSubtype    GuideSubtype?    @map("guide_subtype")
  listicleSubtype ListicleSubtype? @map("listicle_subtype")

  // SEO metrics from DataForSEO
  searchVolume      Int?    @map("search_volume")
  keywordDifficulty Float?  @map("keyword_difficulty")
  cpc               Float?
  competition       String?

  // Scheduling
  scheduledDate DateTime      @map("scheduled_date")
  status        ArticleStatus @default(pending)

  // Generated content (will be populated later)
  content String?

  publishedUrl     String? @map("published_url")
  featuredImageUrl String? @map("featured_image_url")

  publications Publication[]
  jobs         Job[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId, scheduledDate])
  @@index([status])
  @@map("article")
}

model Credential {
  id   String         @id @default(cuid())
  type CredentialType

  name         String?
  refreshToken String? @map("refresh_token")
  accessToken  String? @map("access_token")
  externalId   String? @map("external_id")

  config Json?

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  publications Publication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([type, externalId], name: "unique_external_id")
  @@map("credential")
}

model Publication {
  id String @id @default(cuid())

  url String? @map("url")

  articleId String  @map("article_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  credentialId String     @map("credential_id")
  credential   Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("publication")
}

model Job {
  id     String    @id @default(cuid())
  type   JobType   @default(content_planner)
  status JobStatus @default(pending)

  externalId String? @map("external_id")

  error String?

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  articleId String?  @map("article_id")
  article   Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  @@unique([type, externalId], name: "unique_external_id")
  @@index([type])
  @@map("job")
}

enum ArticleStatus {
  pending
  generated
  published
}

enum JobType {
  content_planner
  article_generation
}

enum JobStatus {
  pending
  error
  running
  done
}

enum CredentialType {
  shopify
  wordpress
  webhook
  notion
  webflow
  wix
  framer
}

model BlogTopicFinderAnalysis {
  id           String   @id @default(cuid())
  baseUrl      String   @map("base_url")
  analyzedUrls String[] @map("analyzed_urls")
  ideas        Json
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([baseUrl])
  @@index([createdAt])
  @@map("blog_topic_finder_analysis")
}
