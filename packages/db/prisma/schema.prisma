generator client {
  provider        = "prisma-client"
  previewFeatures = ["driverAdapters", "fullTextSearchPostgres", "postgresqlExtensions", "queryCompiler", "relationJoins"]
  output          = "./generated"
  engineType      = "client"

  // moduleFormat           = "esm"
  generatedFileExtension = "ts"
  // generated extensions
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // extensions = [pgvector(map: "vector", schema: "public")]
}

model User {
  id               String       @id @default(cuid())
  name             String
  email            String
  emailVerified    Boolean      @default(false)
  image            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @default(now()) @updatedAt
  stripeCustomerId String?
  sessions         Session[]
  accounts         Account[]
  members          Member[]
  invitations      Invitation[]
  jobs             Job[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String   @id @default(cuid())
  expiresAt            DateTime
  token                String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?
  activeProductId      String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Organization {
  id       String  @id @default(cuid())
  name     String
  slug     String?
  logo     String?
  metadata String?

  members     Member[]
  invitations Invitation[]
  products    Product[]

  createdAt DateTime @default(now())

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime     @default(now())

  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Subscription {
  id                   String    @id @default(cuid())
  plan                 String
  referenceId          String
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String?
  periodStart          DateTime?
  periodEnd            DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  cancelAtPeriodEnd    Boolean?  @default(false)
  seats                Int?

  product Product?

  @@map("subscription")
}

model Product {
  id              String   @id @default(cuid())
  url             String
  name            String?
  description     String?
  logo            String?
  language        String?
  country         String?
  targetAudiences String[]
  sitemapUrl      String?
  blogUrl         String?
  bestArticles    String[]

  // Article preferences
  autoPublish         Boolean @default(true)
  articleStyle        String  @default("informative")
  internalLinks       Int     @default(3)
  globalInstructions  String?
  imageStyle          String  @default("brand-text")
  brandColor          String  @default("#000000")
  includeYoutubeVideo Boolean @default(true)
  includeCallToAction Boolean @default(true)
  includeInfographics Boolean @default(true)
  includeEmojis       Boolean @default(true)

  subscriptionId String?       @unique
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  articles    Article[]
  credentials Credential[]
  jobs        Job[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product")
}

enum ArticleType {
  guide
  listicle
}

enum GuideSubtype {
  how_to
  explainer
  comparison
  reference
}

enum ListicleSubtype {
  round_up
  resources
  examples
}

model Article {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Article metadata
  keyword         String
  title           String?
  type            ArticleType
  guideSubtype    GuideSubtype?
  listicleSubtype ListicleSubtype?

  // SEO metrics from DataForSEO
  searchVolume      Int?
  keywordDifficulty Float?
  cpc               Float?
  competition       Float?

  // Scheduling
  scheduledDate DateTime
  status        String   @default("pending") // pending, generated, published

  // Generated content (will be populated later)
  content      String?
  publishedUrl String?

  publications Publication[]
  jobs         Job[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, scheduledDate])
  @@index([status])
  @@map("article")
}

model Credential {
  id   String         @id @default(cuid())
  type CredentialType

  name         String?
  refreshToken String? @map("refresh_token")
  accessToken  String? @map("access_token")
  externalId   String? @map("external_id")

  config Json?

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  publications Publication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([type, externalId], name: "unique_external_id")
  @@map("credential")
}

model Publication {
  id String @id @default(cuid())

  url String? @map("url")

  articleId String  @map("article_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  credentialId String     @map("credential_id")
  credential   Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("publication")
}

model Job {
  id     String    @id @default(cuid())
  type   JobType   @default(content_planner)
  status JobStatus @default(pending)

  externalId String? @map("external_id")

  error String?

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  articleId String?  @map("article_id")
  article   Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  @@unique([type, externalId], name: "unique_external_id")
  @@index([type])
  @@map("job")
}

enum JobType {
  content_planner
  article_generation
}

enum JobStatus {
  pending
  error
  running
  done
}

enum CredentialType {
  shopify
  wordpress
  webhook
  notion
  webflow
  wix
  framer
}
